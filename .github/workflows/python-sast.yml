name: Python SAST Security
on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * 1' # Weekly scan

jobs:
  bandit-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Bandit and SARIF tools
        run: |
          pip install bandit
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð¼ SARIF formatter Ð¸Ð· pip Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹
          pip install bandit-to-sarif || echo "SARIF formatter not available"
          
      - name: Run Bandit security scan
        id: bandit-scan
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ bandit Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² JSON
          bandit -r app/ \
            -f json \
            -o bandit-report.json \
            -ll \
            --confidence-level high \
            --severity-level high \
            --exit-zero
        continue-on-error: true
        
      - name: Convert Bandit JSON to SARIF format
        if: always() && steps.bandit-scan.outcome != 'skipped'
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð»Ð¸ bandit-to-sarif
          if python -c "import bandit_to_sarif" 2>/dev/null; then
            echo "Converting Bandit report to SARIF..."
            bandit-to-sarif -i bandit-report.json -o bandit-results.sarif
          else
            echo "bandit-to-sarif not installed, creating minimal SARIF"
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ SARIF Ñ„Ð°Ð¹Ð» Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
            cat > bandit-results.sarif << 'EOF'
            {
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [
                {
                  "tool": {
                    "driver": {
                      "name": "Bandit",
                      "informationUri": "https://bandit.readthedocs.io/",
                      "rules": []
                    }
                  },
                  "results": []
                }
              ]
            }
            EOF
          fi
          
      - name: Upload to GitHub Security (CodeQL v3)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.sarif
          category: bandit
          wait-for-processing: false
          
      - name: Generate security summary
        if: always()
        run: |
          echo "## ðŸ”’ Python Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "**Scan date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Tool:** Bandit" >> $GITHUB_STEP_SUMMARY
          
          if [ -f bandit-report.json ]; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» JSON Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹
            if jq empty bandit-report.json 2>/dev/null; then
              ISSUES=$(jq '.results | length' bandit-report.json)
              echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
              echo "- **Total issues found:** $ISSUES" >> $GITHUB_STEP_SUMMARY
              
              # Count by severity
              HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json)
              MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-report.json)
              LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-report.json)
              
              echo "- **ðŸ”´ High severity:** $HIGH" >> $GITHUB_STEP_SUMMARY
              echo "- **ðŸŸ¡ Medium severity:** $MEDIUM" >> $GITHUB_STEP_SUMMARY
              echo "- **ðŸŸ¢ Low severity:** $LOW" >> $GITHUB_STEP_SUMMARY
              
              if [ $HIGH -gt 0 ]; then
                echo "### âš ï¸ Critical Issues Found" >> $GITHUB_STEP_SUMMARY
                jq -r '.results[] | select(.issue_severity == "HIGH") | "â€¢ **" + .test_name + "** in `" + .filename + ":" + (.line_number|tostring) + "`"' bandit-report.json | head -5 >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ $ISSUES -eq 0 ]; then
                echo "### âœ… No security issues found!" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "### âŒ Error" >> $GITHUB_STEP_SUMMARY
              echo "Invalid JSON report generated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ Warning" >> $GITHUB_STEP_SUMMARY
            echo "Bandit report file not generated" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Upload Bandit report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-scan-${{ github.sha }}
          path: |
            bandit-report.json
            bandit-results.sarif
          retention-days: 7
          
      - name: Fail on critical security issues
        if: always()
        run: |
          if [ -f bandit-report.json ]; then
            CRITICAL_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
            if [ "$CRITICAL_ISSUES" -gt 0 ]; then
              echo "ðŸš¨ Found $CRITICAL_ISSUES critical security issues"
              echo "These must be fixed before merging"
              exit 1
            fi
          fi
