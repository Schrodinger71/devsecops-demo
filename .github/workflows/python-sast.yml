name: Python SAST Security
on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  bandit-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Bandit
        run: pip install bandit
          
      - name: Run Bandit security scan
        id: bandit-run
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ bandit Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² JSON
          bandit -r app/ \
            -f json \
            -o bandit-report.json \
            -ll \
            --exit-zero
        continue-on-error: true
        
      - name: Create minimal SARIF file
        if: always()
        id: create-sarif
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ SARIF Ñ„Ð°Ð¹Ð»
          cat > bandit-results.sarif << 'EOF'
{
  "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
  "version": "2.1.0",
  "runs": [
    {
      "tool": {
        "driver": {
          "name": "Bandit",
          "informationUri": "https://bandit.readthedocs.io/",
          "rules": []
        }
      },
      "results": []
    }
  ]
}
EOF
          
      - name: Check if SARIF file exists
        id: check-sarif
        run: |
          if [ -f "bandit-results.sarif" ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload to GitHub Security
        if: steps.check-sarif.outputs.sarif_exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit-results.sarif
          category: bandit
          
      - name: Generate security summary
        if: always()
        run: |
          echo "## ðŸ”’ Python Security Scan Results" > $GITHUB_STEP_SUMMARY
          echo "**Scan date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Tool:** Bandit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f bandit-report.json ]; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚ÑŒ JSON
            if jq empty bandit-report.json 2>/dev/null; then
              ISSUES=$(jq '.results | length' bandit-report.json)
              echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
              echo "- **Total issues found:** $ISSUES" >> $GITHUB_STEP_SUMMARY
              
              if [ "$ISSUES" -eq "0" ]; then
                echo "### âœ… No security issues found!" >> $GITHUB_STEP_SUMMARY
              else
                # Count by severity
                HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json)
                MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-report.json)
                LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-report.json)
                
                echo "- **ðŸ”´ High severity:** $HIGH" >> $GITHUB_STEP_SUMMARY
                echo "- **ðŸŸ¡ Medium severity:** $MEDIUM" >> $GITHUB_STEP_SUMMARY
                echo "- **ðŸŸ¢ Low severity:** $LOW" >> $GITHUB_STEP_SUMMARY
                
                if [ "$HIGH" -gt "0" ]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### âš ï¸ Critical Issues (Top 5)" >> $GITHUB_STEP_SUMMARY
                  jq -r '.results[] | select(.issue_severity == "HIGH") | "â€¢ **" + .test_name + "** in `" + .filename + ":" + (.line_number|tostring) + "`"' bandit-report.json | head -5 >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "### âŒ Error" >> $GITHUB_STEP_SUMMARY
              echo "Invalid JSON report generated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ Warning" >> $GITHUB_STEP_SUMMARY
            echo "Bandit report file not generated" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Upload Bandit report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: |
            bandit-report.json
            bandit-results.sarif
          
      - name: Fail on critical security issues
        if: always()
        run: |
          if [ -f bandit-report.json ]; then
            if jq empty bandit-report.json 2>/dev/null; then
              CRITICAL_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json)
              if [ "$CRITICAL_ISSUES" -gt "0" ]; then
                echo "ðŸš¨ Found $CRITICAL_ISSUES critical security issues"
                echo "These must be fixed before merging"
                exit 1
              fi
            fi
          fi
  