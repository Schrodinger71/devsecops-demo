name: Advanced SAST & Code Quality
on: [push, pull_request]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 1. Bandit (основной SAST для Python)
      - name: Run Bandit (security)
        run: |
          pip install bandit
          bandit -r app -f json -o bandit-report.json || true
      
      # # 2. Semgrep (продвинутый шаблонный анализ)
      # - name: Run Semgrep
      #   uses: returntocorp/semgrep-action@v1
      #   with:
      #     config: p/security-audit
      #     output: semgrep-results.json
      
      # 3. Safety (проверка уязвимостей в зависимостях)
      - name: Check dependencies with Safety
        run: |
          pip install safety
          safety check --json > safety-report.json || true
      
      # 4. Detect secrets (поиск захардкоженных секретов)
      - name: Detect secrets with Gitleaks
        uses: gitleaks/gitleaks-action@v2
      
      # 5. Объединение отчетов и проверка
      - name: Process security reports
        run: |
          # Создаем сводный отчет
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          
          # Проверяем Bandit результаты
          if [ -f bandit-report.json ]; then
            BANDIT_ISSUES=$(jq '.results | length' bandit-report.json)
            echo "### Bandit: Found $BANDIT_ISSUES issues" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | "- **" + .issue_confidence + "** " + .test_name + ": " + .issue_text' bandit-report.json | head -10 >> $GITHUB_STEP_SUMMARY
          fi
          
          # Проверяем Safety результаты
          if [ -f safety-report.json ]; then
            SAFETY_ISSUES=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
            echo "### Safety: Found $SAFETY_ISSUES vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          fi
          
      # 6. Fail если найдены критические проблемы
      - name: Fail on critical issues
        run: |
          # Можно настроить логику для блокировки PR
          if [ -f bandit-report.json ]; then
            CRITICAL_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json)
            if [ $CRITICAL_ISSUES -gt 0 ]; then
              echo "Found $CRITICAL_ISSUES HIGH severity issues - failing check"
              exit 1
            fi
          fi
